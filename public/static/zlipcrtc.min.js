!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;t="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,t.zlipcrtc=e()}}(function(){return function e(t,n,r){function i(s,a){if(!n[s]){if(!t[s]){var c="function"==typeof require&&require;if(!a&&c)return c(s,!0);if(o)return o(s,!0);var l=new Error("Cannot find module '"+s+"'");throw l.code="MODULE_NOT_FOUND",l}var u=n[s]={exports:{}};t[s][0].call(u.exports,function(e){var n=t[s][1][e];return i(n||e)},u,u.exports,e,t,n,r)}return n[s].exports}for(var o="function"==typeof require&&require,s=0;s<r.length;s++)i(r[s]);return i}({1:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r={UnknowError:{code:-1,message:"UnknowError"},InvalidSignal:{code:-2,message:"InvalidSignal"},NotSupportWebRTC:{code:-3,message:"Not support WebRTC"},Success:{code:0,message:"Success"},Timeout:{code:1,message:"Timeout"},Unauthorized:{code:2,message:"Unauthorized"},Offline:{code:3,message:"User is offline"},UserNotExist:{code:4,message:"User is not exist"},UserOffline:{code:5,message:"Dest user is offline"},NotAllowed:{code:6,message:"Operation is not allowed"},NotRoomOwner:{code:7,message:"User is not the room's owner"},BeRejected:{code:8,message:"Call or invite be rejected"},IsBusying:{code:9,message:"User is busying"},StatusError:{code:10,message:"Status error"},ConnectServerError:{code:11,message:"Connect server error"},GetUserMediaError:{code:12,message:"GetUserMedia error"},NetworkError:{code:13,message:"Network error"},Byebye:{code:14,message:"Bye-bye"},NotConnected:{code:15,message:"NotConnected"},SetRemoteSDPError:{code:16,message:"SetRemoteSDP error"},PluginDevicePlease:{code:17,message:"Plugin micphone and sounder"}};n.default=r},{}],2:[function(e,t,n){"use strict";function r(e){return i(e,"audio","send","PCMU/8000")}function i(e,t,n,r){var i=t+" "+n+" codec";if(""===r)return console.log("No preference on "+i+"."),e;console.log("Prefer "+i+": "+r);var s=e.split("\r\n"),l=o(s,"m=",t);if(null===l)return e;var u=o(s,"a=rtpmap",r);if(console.log("codecIndex",u),u){var d=a(s[u]);d&&(s[l]=c(s[l],d))}return e=s.join("\r\n")}function o(e,t,n){return s(e,0,-1,t,n)}function s(e,t,n,r,i){for(var o=-1!==n?n:e.length,s=t;s<o;++s)if(0===e[s].indexOf(r)&&(!i||-1!==e[s].toLowerCase().indexOf(i.toLowerCase())))return s;return null}function a(e){var t=new RegExp("a=rtpmap:(\\d+) \\w+\\/\\d+"),n=e.match(t);return n&&2===n.length?n[1]:null}function c(e,t){var n=e.split(" "),r=n.slice(0,3);r.push(t);for(var i=3;i<n.length;i++)n[i]!==t&&r.push(n[i]);return r.join(" ")}function l(e){this.constraint=e,this.localsdp=null,this.remotesdp=null,this.pc=null,this.localStream=null,this.remoteStreams=null,this.mediaElement=null,this.stats=null}Object.defineProperty(n,"__esModule",{value:!0});var u=e("./RtcUtil.js"),d=function(e){return e&&e.__esModule?e:{default:e}}(u);l.prototype.bindMediaElement=function(e){this.mediaElement=e,this.remoteStreams&&e&&(e.pause(),e.srcObject=this.remoteStreams[0],e.play())},l.prototype.start=function(e,t){var n=function(e){console.log("Received local stream"),this.localStream=e;var n=e.getAudioTracks();n.length>0&&console.log("Using Audio device: "+n[0].label);var r=this.pc;r.addTrack?e.getTracks().forEach(function(t){r.addTrack(t,e)}):r.addStream(e),console.log("Adding Local Stream to peer connection");var i={offerToReceiveAudio:1,offerToReceiveVideo:0,voiceActivityDetection:!1},o=function(e){console.error("Failed to set session description: "+e.toString()),t&&t("Failed to set session description: "+e.toString())},s=function(e){console.log("Offer from pc \n"+e.sdp),this.pc.setLocalDescription(e).then(function(){console.log("pc setLocalDescription success")},o)}.bind(this),a=function(e){console.error("Failed to create session description: "+e.toString()),t&&t("Failed to create session description: "+e.toString())};this.pc.createOffer(i).then(s,a)}.bind(this);this.pc=new RTCPeerConnection(null);var i=this,o=function(t){if(i.pc){var n=i.pc.iceGatheringState||i.pc.iceState;console.log("pc state is "+n),"complete"!==n||i.localsdp||(i.localsdp=i.pc.localDescription.sdp,i.localsdp=r(i.localsdp),console.log("after chosen audio sdp is "+i.localsdp),e&&(i.statsInterval&&(clearInterval(i.statsInterval),i.statsInterval=null,i.stats=null),i.constraint.enableStats&&(i.statsInterval=setInterval(function(){var e=i.pc.getSenders();for(var t in e)e[t].getStats&&e[t].getStats().then(function(e){console.log("sender stats : "+JSON.stringify(e.outbound_rtp_audio_0)),i.stats||(i.stats={}),i.stats.outbound=e.outbound_rtp_audio_0});var n=i.pc.getReceivers();for(var r in n)n[r].getStats&&n[r].getStats().then(function(e){console.log("receiver stats : "+JSON.stringify(e.inbound_rtp_audio_0)),i.stats||(i.stats={}),i.stats.outbound=e.inbound_rtp_audio_0})},1e3)),e(i.localsdp)))}}.bind(this),s=function(e){i.remoteStreams=e.streams,i.bindMediaElement(i.mediaElement)}.bind(this);this.pc.onicecandidate=o,this.pc.ontrack=s,navigator.mediaDevices.getUserMedia(this.constraint).then(n.bind(this)).catch(function(e){console.error("getUserMedia error: "+JSON.stringify(e)),t&&t(JSON.stringify(e))})},l.prototype.setRemoteSDP=function(e,t,n){return!!this.pc&&(this.pc.setRemoteDescription(new RTCSessionDescription({type:"answer",sdp:e})).then(function(e){console.log("pc set remote sdp success ${}"),t&&t()},function(e){console.error("pc set remote sdp error "),n&&n()}),!0)},l.prototype.stop=function(){this.statsInterval&&(clearInterval(this.statsInterval),this.statsInterval=null,this.stats=null),this.remoteStreams&&this.remoteStreams[0].getTracks().forEach(function(e){e.stop()}),this.localStream&&this.localStream.getTracks().forEach(function(e){e.stop()}),this.pc&&this.pc.close(),this.pc=null,this.localStream=null,this.remoteStreams=null,this.localsdp=null,this.remotesdp=null},l.prototype.enableMedia=function(e){var t=this;if(e&&e.audio){var n=d.default.browser.firefox,r=this.localStream;r.getTracks().forEach(function(i){i.enabled=e.audio.input,e.audio.input||n||(r.removeTrack(i),t.localTrack=i)});var i=this.remoteStreams[0];i.getTracks().forEach(function(r){r.enabled=e.audio.output,e.audio.output||n||(i.removeTrack(r),t.remoteTrack=r)}),e.audio.input&&!n&&t.localTrack&&(t.localTrack.enabled=!0,r.addTrack(t.localTrack),t.localTrack=null),e.audio.output&&!n&&t.remoteTrack&&(t.remoteTrack.enabled=!0,i.addTrack(t.remoteTrack),t.remoteTrack=null)}},n.default=l},{"./RtcUtil.js":6}],3:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function i(e){this.isConnected=!1,this.addr=e,this.msgs={},this.seq=0,this.requestCB=null}function o(e){}function s(){}Object.defineProperty(n,"__esModule",{value:!0});var a=e("./RtcError.js"),c=r(a),l=e("./RtcSignalProtocal.js"),u=r(l);i.prototype.connect=function(e,t){this.isConnected&&this.disconnect(),this.onOpen=function(){this.isConnected=!0,e&&e()}.bind(this),this.onClose=function(){this.isConnected=!1}.bind(this),this.onError=function(){this.isConnected?t&&t(c.default.NetworkError):t&&t(c.default.ConnectServerError),this.isConnected=!1}.bind(this),this.onMsg=function(e){var t=JSON.parse(e.data);if(t){var n=t.sequence;if(this.msgs[n]){var r=this.msgs[n];this.onResponse(r,t),this.msgs[n]=null}else if(this.requestCB){var i=u.default.parseMsg(null,t);this.requestCB(i)}}else console.warn("RtcSignal recv a invalid msg "+JSON.stringify(e))}.bind(this),this.ws=new WebSocket(this.addr),this.ws.addEventListener("open",this.onOpen),this.ws.addEventListener("close",this.onClose),this.ws.addEventListener("error",this.onError),this.ws.addEventListener("message",this.onMsg)},i.prototype.request=function(e,t,n,r){if(!this.isConnected)return r&&r(c.default.NotConnected),void console.error("RtcSignalWS requet error, not connected !");var i={cmd:e,seq:e.sequence,successcb:n,errorcb:r};this.msgs[i.seq]=i,this.ws.send(JSON.stringify(e)),setTimeout(function(){this.msgs[i.seq]&&(r&&r(c.default.Timeout),this.msgs[i.seq]=null)}.bind(this),t)},i.prototype.disconnect=function(){if(!this.isConnected)return void console.warn("RtcSignalWS disconnect warn, not connected !");this.isConnected=!1,this.ws.close(),this.ws=null},i.prototype.onResponse=function(e,t){var n=u.default.parseMsg(e,t);n.code==c.default.Success?e.successcb&&e.successcb(n):e.errorcb&&e.errorcb(n.code)},s.createSignal=function(e){return e&&e.type?"ws"==e.type?new i(e.addr):"http"==e.type?new o(e.addr):(console.error("RtcSignal createSignal error !! invalid type ["+e.type+"]"),null):(console.error("RtcSignal createSignal error !! config is ["+e+"]"),null)},n.default=s},{"./RtcError.js":1,"./RtcSignalProtocal.js":4}],4:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=e("./RtcError.js"),i=function(e){return e&&e.__esModule?e:{default:e}}(r),o={sequence:0,token:"zailingtech",version:"1.0"};o.createCallCmd=function(e,t){if(e&&t){return{command:"call",version:o.version,token:o.token,from:e.id,sequence:(o.sequence++).toString(),body:{to:t.id,devicetype:t.devicetype,channel:t.channel?t.channel.toString():"0",sdp:e.sdp}}}return null},o.createHangupCmd=function(e,t){if(e&&t){return{command:"bye",version:o.version,token:o.token,from:e.id,sequence:(o.sequence++).toString(),body:{to:t.id,devicetype:t.devicetype,channel:t.channel}}}return null},o.parseMsg=function(e,t){var n=0,r=t?t.body:null;if(e&&e.cmd&&"call"==e.cmd.command&&t&&t.status)switch(t.status){case"200":n=i.default.Success,r=t.body.sdp;break;case"600":n=i.default.BeRejected;break;case"404":n=i.default.UserOffline;break;case"486":n=i.default.IsBusying;break;case"500":n=i.default.UnknowError;break;default:n=i.default.InvalidSignal}return{code:n,command:"response",param:r}},n.default=o},{"./RtcError.js":1}],5:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function i(e){this.info=e,this.signal=u.default.createSignal(s.default.config.signalConfig);var t={video:!1,audio:!0,enableStats:!1};this.mediachannel=new h.default(t),this.mediachannel.bindMediaElement(this.info.mediaElement),this.isCalling=!1,this.callInfo=null,this.errorCb=null}Object.defineProperty(n,"__esModule",{value:!0});var o=e("./zlipcrtc.js"),s=r(o),a=e("./RtcError.js"),c=r(a),l=e("./RtcSignal.js"),u=r(l),d=e("./RtcSignalProtocal.js"),f=r(d),g=e("./RtcMediaChannel.js"),h=r(g);i.prototype.onMsg=function(e){switch(e.command){case"bye":this.errorCb&&this.errorCb(this,c.default.Byebye),s.default.logger.write("zlipcrtc","debug","RtcUserAgent "+this.info.id+" recv a bye msg",!0)}},i.prototype.call=function(e,t,n){if(!s.default.supportWebRTC)return n&&n(this,c.default.NotSupportWebRTC),void s.default.logger.write("zlipcrtc","error","RtcUserAgent "+this.info.id+" call to "+e.id+" error : "+c.default.NotSupportWebRTC.message,!0);if(!s.default.devices.hasAudioInput)return n&&n(this,c.default.PluginDevicePlease),void s.default.logger.write("zlipcrtc","error","RtcUserAgent "+this.info.id+" call to "+e.id+" error : "+c.default.PluginDevicePlease.message,!0);if(this.isCalling)return n&&n(this,c.default.StatusError),void s.default.logger.write("zlipcrtc","error","RtcUserAgent "+this.info.id+" call to "+e.id+" error : is calling",!0);this.isCalling=!0,this.errorCb=n;var r=function(r){if(this.mediachannel){var i=function(){t&&t(this),s.default.logger.write("zlipcrtc","debug","RtcUserAgent "+this.info.id+" call to "+e.id+" success remote sdp : "+JSON.stringify(r),!0)},o=function(){n&&n(this,c.default.SetRemoteSDPError),s.default.logger.write("zlipcrtc","error","RtcUserAgent "+this.info.id+" call to "+e.id+" error : "+c.default.SetRemoteSDPError.message+" remote sdp : "+JSON.stringify(r),!0)};r&&r.param&&this.mediachannel.setRemoteSDP(r.param,i.bind(this),o.bind(this))||(n&&n(this,c.default.SetRemoteSDPError),s.default.logger.write("zlipcrtc","error","RtcUserAgent "+this.info.id+" call to "+e.id+" error : "+c.default.SetRemoteSDPError.message,!0))}},i=function(t){this.mediachannel.stop(),n&&n(this,t),s.default.logger.write("zlipcrtc","error","RtcUserAgent "+this.info.id+" call to "+e.id+" error "+JSON.stringify(t),!0)},o=function(t){this.callInfo={from:{id:this.info.id,sdp:t},to:e},s.default.logger.write("zlipcrtc","debug","RtcUserAgent "+this.info.id+" call to "+e.id+" onMediaSuccess sdp : "+t+"}",!0);var o=function(){s.default.logger.write("zlipcrtc","debug","RtcUserAgent "+this.info.id+" call to "+e.id+" signal connected, start signel call request",!0),this.signal.request(f.default.createCallCmd(this.callInfo.from,e),5e3,r.bind(this),i.bind(this)),this.signal.requestCB=this.onMsg},a=function(t){this.mediachannel.stop(),n&&n(this,t),s.default.logger.write("zlipcrtc","error","RtcUserAgent "+this.info.id+" call to "+e.id+" signal connect error "+JSON.stringify(t),!0)};s.default.logger.write("zlipcrtc","debug","RtcUserAgent "+this.info.id+" call to "+e.id+" signal connect",!0),this.signal.connect(o.bind(this),a.bind(this))},a=function(t){this.mediachannel.stop(),n&&n(this,c.default.GetUserMediaError,t),s.default.logger.write("zlipcrtc","error","RtcUserAgent "+this.info.id+" call to "+e.id+" onMediaError "+JSON.stringify(t),!0)};this.mediachannel.start(o.bind(this),a.bind(this))},i.prototype.enableMedia=function(e){this.mediachannel&&this.mediachannel.enableMedia(e)},i.prototype.hangup=function(){function e(){s.default.logger.write("zlipcrtc","debug","RtcUserAgent "+this.info.id+" hangup success to "+this.callInfo.to.id,!0)}function t(){s.default.logger.write("zlipcrtc","error","RtcUserAgent "+this.info.id+" hangup error to "+this.callInfo.to.id,!0)}if(!this.isCalling)return void s.default.logger.write("zlipcrtc","warn","RtcUserAgent "+this.info.id+" hangup warn, is not calling",!0);this.isCalling=!1,this.mediachannel.stop(),this.signal.request(f.default.createHangupCmd(this.callInfo.from,this.callInfo.to,5e3,e,t)),setTimeout(function(){this.signal.disconnect(),this.callInfo=null}.bind(this),2e3)},n.default=i},{"./RtcError.js":1,"./RtcMediaChannel.js":2,"./RtcSignal.js":3,"./RtcSignalProtocal.js":4,"./zlipcrtc.js":9}],6:[function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),o=function(){function e(){r(this,e)}return i(e,null,[{key:"checkDevices",value:function(){return new Promise(function(e,t){if(!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices)return void t("not support webrtc");navigator.mediaDevices.enumerateDevices().then(function(t){var n={hasAudioInput:!1,hasAudioOutput:!1,hasVideoInput:!1};t.forEach(function(e){"audioinput"===e.kind?n.hasAudioInput=!0:"audiooutput"===e.kind?n.hasAudioOutput=!0:"videoinput"===e.kind&&(n.hasVideoInput=!0)}),e(n),console.log("media devices : "+JSON.stringify(t))}).catch(function(e){t(e)})})}}]),e}();o.supportWebRTC=navigator.mediaDevices&&navigator.mediaDevices.enumerateDevices;var s=self.navigator.userAgent.toLowerCase(),a=/(edge)\/([\w.]+)/.exec(s)||/(opr)[\/]([\w.]+)/.exec(s)||/(chrome)[ \/]([\w.]+)/.exec(s)||/(iemobile)[\/]([\w.]+)/.exec(s)||/(version)(applewebkit)[ \/]([\w.]+).*(safari)[ \/]([\w.]+)/.exec(s)||/(webkit)[ \/]([\w.]+).*(version)[ \/]([\w.]+).*(safari)[ \/]([\w.]+)/.exec(s)||/(webkit)[ \/]([\w.]+)/.exec(s)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(s)||/(msie) ([\w.]+)/.exec(s)||s.indexOf("trident")>=0&&/(rv)(?::| )([\w.]+)/.exec(s)||s.indexOf("compatible")<0&&/(firefox)[ \/]([\w.]+)/.exec(s)||[],c=/(ipad)/.exec(s)||/(ipod)/.exec(s)||/(windows phone)/.exec(s)||/(iphone)/.exec(s)||/(kindle)/.exec(s)||/(android)/.exec(s)||/(windows)/.exec(s)||/(mac)/.exec(s)||/(linux)/.exec(s)||/(cros)/.exec(s)||[],l={browser:a[5]||a[3]||a[1]||"",version:a[2]||a[4]||"0",majorVersion:a[4]||a[2]||"0",platform:c[0]||""},u={};if(l.browser){u[l.browser]=!0;var d=l.majorVersion.split(".");u.version={major:parseInt(l.majorVersion,10),string:l.version},d.length>1&&(u.version.minor=parseInt(d[1],10)),d.length>2&&(u.version.build=parseInt(d[2],10))}o.browser=u,n.default=o},{}],7:[function(e,t,n){"use strict";t.exports=e("./zlipcrtc.js").default},{"./zlipcrtc.js":9}],8:[function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),o=function(){function e(t,n,i){if(r(this,e),this._name=t||"ZLLogger",this._maxcount=i||1048576,n){var o=indexedDB.open(this._name,1);o.onerror=function(e){console.error("ZLLogger open db error")},o.onsuccess=function(e){this._dataBase=e.target.result,this._isValid=!0}.bind(this),o.onupgradeneeded=function(e){var t=e.target.result;if(!t.objectStoreNames.contains(this._name)){var n=t.createObjectStore(this._name);n.createIndex("name","name"),n.createIndex("tag","tag"),n.createIndex("level","level"),n.createIndex("time","time"),n.createIndex("info","info")}}.bind(this)}else this._isValid=!0}return i(e,[{key:"write",value:function(e,t,n,r){if(!this._isValid)return void console.warn("invalid ZLLogger");var i=new Date;if(this._dataBase){var o=this._dataBase.transaction(this._name,"readwrite").objectStore(this._name);if(o){var s=o.count();s.onsuccess=function(){if(s.result>=this._maxcount){var e=IDBKeyRange.upperBound((new Date).getTime()),t=0;o.openCursor(e).onsuccess=function(e){var n=e.target.result;n&&(o.delete(n.key),++t<100&&n.continue())}}}.bind(this),o.put({name:this._name,tag:e,level:t,time:i.toString(),info:n},i.getTime())}}if(r){var a=console.log;"warn"===t?a=console.warn:"error"===t&&(a=console.error),a("["+this._name+"]["+e+"]["+t+"]["+i.toString()+"]  "+n)}}},{key:"query",value:function(e,t){if(!this._isValid)return void console.warn("invalid ZLLogger");var n=IDBKeyRange.bound(e,t,!0,!0);this._dataBase.transaction(this._name).objectStore(this._name).openCursor(n).onsuccess=function(e){var t=e.target.result;t&&(console.log(JSON.stringify(t.value)),t.continue())}}},{key:"clear",value:function(){if(console.warn("clear log"),this._dataBase){this._dataBase.transaction(this._name,"readwrite").objectStore(this._name).clear()}}}]),e}();n.default=o},{}],9:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(n,"__esModule",{value:!0});var i=e("./RtcUserAgent.js"),o=r(i),s=e("./RtcError"),a=r(s),c=e("./logger.js"),l=r(c),u=e("./RtcUtil.js"),d=r(u),f={version:"1.0.3",uas:{},config:null,logger:new l.default("zlipcrtc.js"),devices:{hasAudioInput:!1}};f.init=function(e,t,n){f.logger.write("zlipcrtc","debug","zlipcrtc.js init , browser info is "+JSON.stringify(d.default.browser),!0),f.config=e,f.supportWebRTC=d.default.supportWebRTC,f.supportWebRTC?d.default.checkDevices().then(function(e){f.devices=e,f.devices.hasAudioInput?(t(),f.logger.write("zlipcrtc","debug","enumerateDevices success")):(n(a.default.PluginDevicePlease),f.logger.write("zlipcrtc","error","init error, enumerateDevices : "+a.default.PluginDevicePlease.message,!0))}).catch(function(e){n(a.default.PluginDevicePlease),f.logger.write("zlipcrtc","error",e.name+":"+e.message,!0)}):n&&(n(a.default.NotSupportWebRTC),f.logger.write("zlipcrtc","error","init error : "+a.default.NotSupportWebRTC.message,!0))},f.createUserAgent=function(e){f.destroyUserAgent(e.id);var t=new o.default(e);return f.uas[e.id]=t,t},f.getUserAgent=function(e){return f.uas[e]},f.destroyUserAgent=function(e){f.uas[e]&&(f.uas[e]=null)},f.clearUserAgent=function(){for(var e in f.uas){var t=f.uas[e];t&&(t=null)}},n.default=f},{"./RtcError":1,"./RtcUserAgent.js":5,"./RtcUtil.js":6,"./logger.js":8}]},{},[7])(7)});
//# sourceMappingURL=zlipcrtc.min.js.map
